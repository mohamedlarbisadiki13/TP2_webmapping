<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Carte Choropl√®the - Population par R√©gion au Maroc</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Open+Sans:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Open Sans', sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
      color: #333;
      line-height: 1.6;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 20px;
    }
    
    header {
      background: linear-gradient(to right, #67000d, #a50f15);
      color: white;
      padding: 25px 0;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .page-title {
      font-family: 'Montserrat', sans-serif;
      font-weight: 700;
      font-size: 28px;
      letter-spacing: 0.5px;
    }
    
    .author {
      font-weight: 300;
      font-size: 16px;
      opacity: 0.9;
    }
    
    .description {
      margin-top: 15px;
      font-size: 16px;
      max-width: 800px;
      line-height: 1.7;
      opacity: 0.9;
    }
    
    main {
      padding: 30px 0;
    }
    
    .map-container {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
      border: 1px solid #e1e8ed;
      padding: 20px;
      margin-bottom: 30px;
    }
    
    .map-frame {
      border: 2px solid #e1e8ed;
      border-radius: 8px;
      overflow: hidden;
      height: 70vh;
      min-height: 500px;
    }
    
    #map {
      width: 100%;
      height: 100%;
    }
    
    .info-section {
      display: flex;
      gap: 30px;
      margin-top: 30px;
      flex-wrap: wrap;
    }
    
    .info-card {
      flex: 1;
      min-width: 300px;
      background: white;
      border-radius: 10px;
      padding: 25px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
      border-top: 4px solid #a50f15;
    }
    
    .info-card h3 {
      font-family: 'Montserrat', sans-serif;
      color: #2c3e50;
      margin-bottom: 15px;
      font-size: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .info-card h3 i {
      color: #a50f15;
    }
    
    .info-card p {
      margin-bottom: 15px;
      color: #555;
    }
    
    footer {
      background: #2c3e50;
      color: #ecf0f1;
      padding: 30px 0;
      text-align: center;
      margin-top: 40px;
    }
    
    .footer-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 20px;
    }
    
    .footer-info {
      text-align: left;
    }
    
    .footer-info p {
      margin-bottom: 5px;
    }
    
    .footer-links {
      display: flex;
      gap: 20px;
    }
    
    .footer-links a {
      color: #ecf0f1;
      text-decoration: none;
      transition: color 0.3s;
    }
    
    .footer-links a:hover {
      color: #a50f15;
    }
    
    .copyright {
      margin-top: 20px;
      font-size: 14px;
      opacity: 0.7;
      width: 100%;
    }
    
    /* Leaflet Overrides */
    .leaflet-top.leaflet-left { top: 10px; left: 10px; }
    .leaflet-top.leaflet-right { top: 10px; right: 10px; }
    .leaflet-bottom.leaflet-left { bottom: 10px; left: 10px; }
    .leaflet-bottom.leaflet-right { bottom: 30px; right: 10px; }
    
    .leaflet-control-layers {
      border-radius: 8px !important;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
    }
    
    .info {
      padding: 12px 15px;
      background: rgba(255, 255, 255, 0.95);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      border-radius: 10px;
      font: 14px/1.5 'Open Sans', sans-serif;
      border: 1px solid #e1e8ed;
      max-width: 280px;
    }
    
    .info h4 {
      margin: 0 0 10px;
      color: #2c3e50;
      font-family: 'Montserrat', sans-serif;
      font-weight: 600;
      font-size: 16px;
      border-bottom: 1px solid #eee;
      padding-bottom: 8px;
    }
    
    .legend {
      line-height: 20px;
      color: #555;
      background: rgba(255, 255, 255, 0.95);
      padding: 12px 15px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      border: 1px solid #e1e8ed;
      max-width: 220px;
    }
    
    .legend i {
      width: 20px;
      height: 20px;
      float: left;
      margin-right: 10px;
      opacity: 0.85;
      border-radius: 3px;
    }
    
    .legend-title {
      margin-bottom: 8px;
      font-weight: 600;
      color: #2c3e50;
      font-family: 'Montserrat', sans-serif;
    }
    
    .stats-box {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px dashed #ddd;
    }
    
    .stat-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
    }
    
    .stat-label {
      font-weight: 500;
      color: #555;
    }
    
    .stat-value {
      font-weight: 600;
      color: #2c3e50;
    }
    
    .region-name {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 8px;
      color: #a50f15;
      font-family: 'Montserrat', sans-serif;
    }
    
    /* --- NOUVEAU --- Style pour la bo√Æte de r√©sultat WPS */
    .wps-box {
        border-top: 1px dashed #c00 !important; 
        margin-top: 10px !important; 
        padding-top: 10px !important;
    }
    .wps-label {
        color: #a50f15 !important; 
        font-weight: bold !important;
    }
    .wps-value {
        color: #a50f15 !important;
        font-weight: bold !important;
    }
    /* --- FIN NOUVEAU --- */
    
    .leaflet-control-attribution {
      background: rgba(255, 255, 255, 0.9) !important;
      border-radius: 4px !important;
      padding: 2px 8px !important;
      font-size: 11px !important;
    }
    
    @media (max-width: 768px) {
      /* ... (vos styles media query restent inchang√©s) ... */
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="header-content">
        <div>
          <h1 class="page-title">Carte Choropl√®the - Population par R√©gion au Maroc</h1>
          <p class="author">R√©alis√© par Mohamed larbi Sadiki</p>
        </div>
      </div>
      <p class="description">
        Cette carte interactive pr√©sente la r√©partition de la population marocaine par r√©gion. <br>
        Les donn√©es incluent la population totale, le nombre de marocains, d'√©trangers et de m√©nages.
      </p>
    </div>
  </header>

  <main class="container">
    <div class="map-container">
      <div class="map-frame">
        <div id="map"></div>
      </div>
    </div>
    
    <div class="info-section">
      <div class="info-card">
        <h3><i>üìä</i> √Ä propos de cette visualisation</h3>
        <p>Cette carte choropl√®the repr√©sente la distribution de la population marocaine √† travers les diff√©rentes r√©gions du pays. Les couleurs indiquent les diff√©rents seuils de population.</p>
        <p>Passez votre souris sur une r√©gion pour voir les d√©tails d√©mographiques, ou cliquez pour zoomer et calculer la surface via un service WPS.</p>
      </div>
      
      <div class="info-card">
        <h3><i>üîç</i> Comment utiliser la carte</h3>
        <p><strong>Survoler une r√©gion</strong> : Affiche les informations d√©taill√©es sur la population</p>
        <p><strong>Cliquer sur une r√©gion</strong> : Zoome et calcule la surface de la r√©gion (via WPS)</p>
        <p><strong>Utiliser les contr√¥les</strong> : Zoomer/d√©zoomer avec les boutons +/-</p>
        <p><strong>Changer le fond de carte</strong> : Utiliser le contr√¥le en haut √† droite</p>
        <p><strong>L√©gende</strong> : Comprendre la signification des couleurs (en bas √† droite)</p>
      </div>
      
      <div class="info-card">
        <h3><i>üìà</i> M√©thodologie</h3>
        <p>Les donn√©es de population sont bas√©es sur le recensement officiel. Les donn√©es de surface sont calcul√©es en temps r√©el en appelant un service web de g√©otraitement (WPS) h√©berg√© localement.</p>
        <p>Le calcul de surface utilise une reprojection vers un CRS mondial √©quivalent (EPSG:6933) pour garantir des r√©sultats pr√©cis en m¬≤.</p>
      </div>
    </div>
  </main>

  <footer>
    <div class="container">
      <div class="footer-content">
        <div class="footer-info">
          <p><strong>Carte Choropl√®the - Population par R√©gion au Maroc</strong></p>
          <p>R√©alis√© par Mohamed larbi Sadiki</p>
        </div>
        
        <div class="footer-links">
          <a href="#">Accueil</a>
          <a href="#">√Ä propos</a>
          <a href="#">Contact</a>
        </div>
        
        <div class="copyright">
          <p>&copy; 2025 - Tous droits r√©serv√©s | Donn√©es cartographiques ¬© OpenStreetMap contributeurs</p>
        </div>
      </div>
    </div>
  </footer>

  <script src="./Carte Choropl√®the - Population par r√©gion_files/Population-region.js.download"></script>

  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script>
    // Initialize the map
    const map = L.map('map').setView([31.5, -7.5], 6);

    // Define multiple base maps
    const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    });
    const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
      maxZoom: 18
    });
    const lightLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
      subdomains: 'abcd',
      maxZoom: 20
    });
    osmLayer.addTo(map);

    // Create layer control
    const baseMaps = {
      "Carte Standard": osmLayer,
      "Vue Satellite": satelliteLayer,
      "Carte Claire": lightLayer
    };
    const layersControl = L.control.layers(baseMaps, null, {
      position: 'topright'
    }).addTo(map);

    // Create info control
    const info = L.control({ position: 'topleft' });

    // --- MODIFI√â --- 
    // Mise √† jour de la fonction info.update pour inclure un placeholder WPS
    info.onAdd = function () {
      this._div = L.DomUtil.create('div', 'info');
      this.update();
      return this._div;
    };

    info.update = function (props) {
      const baseHtml = '<h4>Population R√©gionale</h4>' +
        (props
          ? `<div class="region-name">${props.nom_region}</div>
             <div class="stat-item">
               <span class="stat-label">Population totale:</span>
               <span class="stat-value">${Number(props[" Populatio"]).toLocaleString()}</span>
             </div>
             <div class="stats-box">
               <div class="stat-item">
                 <span class="stat-label">Marocains:</span>
                 <span class="stat-value">${Number(props[" Marocains"]).toLocaleString()}</span>
               </div>
               <div class="stat-item">
                 <span class="stat-label">√âtrangers:</span>
                 <span class="stat-value">${Number(props.Etrangers).toLocaleString()}</span>
               </div>
               <div class="stat-item">
                 <span class="stat-label">M√©nages:</span>
                 <span class="stat-value">${Number(props[" Menages"]).toLocaleString()}</span>
               </div>
             </div>`
          : 'Survolez une r√©gion pour les d√©tails.<br><b>Cliquez pour calculer la surface.</b>');
      
      // Ajoute un placeholder pour le r√©sultat WPS, cach√© par d√©faut
      const wpsHtml = `
        <div class="stats-box wps-box" id="wps-result-box" style="display: none;">
          <div class="stat-item">
            <span class="stat-label wps-label">Surface (WPS):</span>
            <span class="stat-value wps-value" id="wps-area-value">...</span>
          </div>
        </div>`;

      this._div.innerHTML = baseHtml + wpsHtml;
    };
    info.addTo(map);

    // Color scheme
    function getColor(d) {
      d = Number(d);
      return d > 5132639 ? '#67000d' :
             d > 3020431 ? '#a50f15' :
             d > 1655623 ? '#de2d26' :
             d >= 219965  ? '#fb6a4a' :
                            '#fff5f0';
    }

    // Style function
    function style(feature) {
      return {
        fillColor: getColor(feature.properties[" Populatio"]),
        weight: 1,
        opacity: 1,
        color: 'white',
        dashArray: '3',
        fillOpacity: 0.7
      };
    }

    // Highlight feature
    function highlightFeature(e) {
      const layer = e.target;
      layer.setStyle({
        weight: 3,
        color: '#666',
        dashArray: '',
        fillOpacity: 0.9
      });
      layer.bringToFront();
      info.update(layer.feature.properties);
    }

    // Reset highlight
    function resetHighlight(e) {
      geojson.resetStyle(e.target);
      info.update();
    }

    // --- NOUVEAU ---
    // Fonction pour g√©rer le clic sur une r√©gion
    function onRegionClick(e) {
      // 1. Zoomer sur la r√©gion
      map.fitBounds(e.target.getBounds());
      
      const layer = e.target;
      const feature = layer.feature;
      
      // 2. Mettre √† jour la bo√Æte d'info pour afficher "Calcul en cours..."
      const wpsResultBox = info._div.querySelector('#wps-result-box');
      const wpsValue = info._div.querySelector('#wps-area-value');
      
      if (wpsResultBox && wpsValue) {
        wpsValue.textContent = 'Calcul en cours...';
        wpsResultBox.style.display = 'block'; // Rendre la bo√Æte visible
      }

      // 3. Appeler la fonction WPS
      callWPSArea(feature, wpsValue, wpsResultBox);
    }

    // --- NOUVEAU (Version Corrig√©e 2) ---
    // Fonction asynchrone pour appeler le serveur WPS
    async function callWPSArea(feature, wpsValueElement, wpsBoxElement) {
      const wpsUrl = 'http://127.0.0.1:5000/wps';
      const processId = 'universal_area'; 
      
      const geometry = feature.geometry; 

      // --- CORRECTION N¬∞2 ---
      // Emballer notre "Feature" dans une "FeatureCollection"
      // C'est le format de fichier GeoJSON le plus standard que Fiona s'attend √† lire.
      const geojsonFeatureCollection = {
        "type": "FeatureCollection",
        "features": [
          {
            "type": "Feature",
            "properties": {}, // Les propri√©t√©s n'ont pas d'importance pour le calcul
            "geometry": geometry 
          }
        ]
      };
      // --- FIN CORRECTION N¬∞2 ---

      // Construire le corps de la requ√™te XML
      const xmlBody = `
      <wps:Execute version="1.0.0" service="WPS" xmlns:wps="http://www.opengis.net/wps/1.0.0" xmlns:ows="http://www.opengis.net/ows/1.1" xmlns:xlink="http://www.w3.org/1999/xlink">
          <ows:Identifier>${processId}</ows:Identifier>
          <wps:DataInputs>
              <wps:Input>
                  <ows:Identifier>input_layer</ows:Identifier>
                  <wps:Data>
                      <wps:ComplexData mimeType="application/geojson">
                          <![CDATA[${JSON.stringify(geojsonFeatureCollection)}]]>
                      </wps:ComplexData>
                  </wps:Data>
              </wps:Input>
          </wps:DataInputs>
          <wps:ResponseForm>
              <wps:ResponseDocument storeExecuteResponse="false" status="false">
                  <wps:Output asReference="false">
                      <ows:Identifier>total_area</ows:Identifier>
                  </wps:Output>
              </wps:ResponseDocument>
          </wps:ResponseForm>
      </wps:Execute>`;
      
      try {
        const response = await fetch(wpsUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/xml' },
            body: xmlBody
        });

        const xmlString = await response.text();
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(xmlString, "text/xml");

        if (!response.ok) {
           // Si c'est une erreur 400, le serveur renvoie un XML d'erreur
           const errorNode = xmlDoc.querySelector("ExceptionText");
           throw new Error(errorNode ? errorNode.textContent : `Erreur HTTP ${response.status}`);
        }
        
        const outputNode = xmlDoc.querySelector("LiteralData");
        
        if (outputNode) {
            const area = parseFloat(outputNode.textContent);
            const areaInKm2 = (area / 1_000_000).toLocaleString('fr-FR', { maximumFractionDigits: 2 });
            wpsValueElement.textContent = `${areaInKm2} km¬≤`;
        } else {
            throw new Error('R√©ponse XML inconnue du serveur.');
        }

      } catch (error) {
        console.error('Erreur lors de l_appel WPS:', error);
        wpsValueElement.textContent = `Erreur: ${error.message}`;
      } finally {
        wpsBoxElement.style.display = 'block';
      }
    }
    
    // --- MODIFI√â ---
    // Fonction d'ajout des √©v√©nements (on remplace 'zoomToFeature' par 'onRegionClick')
    function onEachFeature(feature, layer) {
      layer.on({
        mouseover: highlightFeature,
        mouseout: resetHighlight,
        click: onRegionClick  // Clic appelle maintenant la nouvelle fonction
      });
    }

    // Create the GeoJSON layer
    const geojson = L.geoJson(region, {
      style: style,
      onEachFeature: onEachFeature
    }).addTo(map);

    // Create legend
    const legend = L.control({ position: 'bottomright' });
    legend.onAdd = function () {
      const div = L.DomUtil.create('div', 'info legend');
      const grades = [219965, 1655623, 3020431, 5132639, 7688967];
      const labels = ['<div class="legend-title">Population par r√©gion</div>'];
      for (let i = 0; i < grades.length; i++) {
        const from = grades[i];
        const to = grades[i + 1];
        labels.push(
          `<i style="background:${getColor(from + 1)}"></i> ${from.toLocaleString()}${to ? '&ndash;' + to.toLocaleString() : '+'}`
        );
      }
      div.innerHTML = labels.join('<br>');
      return div;
    };
    legend.addTo(map);
  </script>
</body>
</html>

